<!doctype html><html lang=en-us dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Using a Service Principal, it is possible to leverage Azure Key Vault on on-prem/non-Azure k8s clusters."><title>Consume Secrets in Azure Key vault From Kubernetes On-prem</title><link rel=canonical href=https://www.chingono.com/blog/2022/11/07/consume-secrets-in-azure-keyvault-from-kubernetes-onprem/><link rel=stylesheet href=/scss/style.min.b80bf249ce4a22cf55e8d7340a0b37a2f2c10f54f3a9a49cb94b694a2eb0bbea.css><meta property="og:title" content="Consume Secrets in Azure Key vault From Kubernetes On-prem"><meta property="og:description" content="Using a Service Principal, it is possible to leverage Azure Key Vault on on-prem/non-Azure k8s clusters."><meta property="og:url" content="https://www.chingono.com/blog/2022/11/07/consume-secrets-in-azure-keyvault-from-kubernetes-onprem/"><meta property="og:site_name" content="Alfero Chingono"><meta property="og:type" content="article"><meta property="article:section" content="Post"><meta property="article:tag" content="kubernetes"><meta property="article:tag" content="azure"><meta property="article:tag" content="keyvault"><meta property="article:tag" content="secrets"><meta property="article:published_time" content="2022-11-07T18:32:15+00:00"><meta property="article:modified_time" content="2022-11-08T17:28:10+00:00"><meta property="og:image" content="https://www.chingono.com/blog/2022/11/07/consume-secrets-in-azure-keyvault-from-kubernetes-onprem/cover.png"><meta name=twitter:site content="@achingono"><meta name=twitter:creator content="@achingono"><meta name=twitter:title content="Consume Secrets in Azure Key vault From Kubernetes On-prem"><meta name=twitter:description content="Using a Service Principal, it is possible to leverage Azure Key Vault on on-prem/non-Azure k8s clusters."><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://www.chingono.com/blog/2022/11/07/consume-secrets-in-azure-keyvault-from-kubernetes-onprem/cover.png"><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-1589660-8","auto"),ga("send","pageview"))</script><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><script type=text/javascript>(function(e,t,n,s,o,i,a){e[n]=e[n]||function(){(e[n].q=e[n].q||[]).push(arguments)},i=t.createElement(s),i.async=1,i.src="https://www.clarity.ms/tag/"+o,a=t.getElementsByTagName(s)[0],a.parentNode.insertBefore(i,a)})(window,document,"clarity","script","b37k7nmp0e")</script></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_hu3a264f08247c62e220aca1ae3ddb41c3_4625_300x0_resize_q75_box.jpg width=300 height=300 class=site-logo loading=lazy alt=Avatar></a>
<span class=emoji>ðŸ”†</span></figure><div class=site-meta><h1 class=site-name><a href=/>Alfero Chingono</a></h1><h2 class=site-description>Cloud Solutions Architect | DevOps Advocate | Trusted Advisor</h2></div></header><ol class=social-menu><li><a href=https://github.com/achingono target=_blank title=GitHub><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href=https://www.linkedin.com/in/achingono/ target=_blank title=LinkedIn><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-linkedin" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><rect x="4" y="4" width="16" height="16" rx="2"/><line x1="8" y1="11" x2="8" y2="16"/><line x1="8" y1="8" x2="8" y2="8.01"/><line x1="12" y1="16" x2="12" y2="11"/><path d="M16 16v-3a2 2 0 00-4 0"/></svg></a></li><li><a href=https://twitter.com/achingono target=_blank title=Twitter><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M22 4.01c-1 .49-1.98.689-3 .99-1.121-1.265-2.783-1.335-4.38-.737S11.977 6.323 12 8v1c-3.245.083-6.135-1.395-8-4 0 0-4.182 7.433 4 11-1.872 1.247-3.739 2.088-6 2 3.308 1.803 6.913 2.423 10.034 1.517 3.58-1.04 6.522-3.723 7.651-7.742a13.84 13.84.0 00.497-3.753C20.18 7.773 21.692 5.25 22 4.009z"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg><span>Home</span></a></li><li><a href=/about/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg><span>About Me</span></a></li><li><a href=/archives/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg><span>Archives</span></a></li><li><a href=/search/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg><span>Search</span></a></li><div class=menu-bottom-section><li id=dark-mode-toggle><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><span>Dark Mode</span></li></div></ol></aside><main class="main full-width"><article class="has-image main-article" data-clarity-region=article><header class=article-header><div class=article-image><a href=/blog/2022/11/07/consume-secrets-in-azure-keyvault-from-kubernetes-onprem/><img src=/blog/2022/11/07/consume-secrets-in-azure-keyvault-from-kubernetes-onprem/cover_hu2127c06d6b285e6efc79228e9ee40ab3_50152_800x0_resize_box_3.png srcset="/blog/2022/11/07/consume-secrets-in-azure-keyvault-from-kubernetes-onprem/cover_hu2127c06d6b285e6efc79228e9ee40ab3_50152_800x0_resize_box_3.png 800w, /blog/2022/11/07/consume-secrets-in-azure-keyvault-from-kubernetes-onprem/cover_hu2127c06d6b285e6efc79228e9ee40ab3_50152_1600x0_resize_box_3.png 1600w" width=800 height=150 loading=lazy alt="Featured image of post Consume Secrets in Azure Key vault From Kubernetes On-prem"></a></div><div class=article-details><header class=article-category><a href=/categories/containers/>containers</a>
<a href=/categories/cloud/>cloud</a>
<a href=/categories/key-management/>key management</a>
<a href=/categories/security/>security</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/blog/2022/11/07/consume-secrets-in-azure-keyvault-from-kubernetes-onprem/>Consume Secrets in Azure Key vault From Kubernetes On-prem</a></h2><h3 class=article-subtitle>Using a Service Principal, it is possible to leverage Azure Key Vault on on-prem/non-Azure k8s clusters.</h3></div><footer class=article-time><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg><time class=article-time--published>Nov 07, 2022</time></div><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg><time class=article-time--reading>9 minute read</time></div></footer></div></header><section class=article-content><p>Recently, a customer inquired if there is a way to leverage Azure Key Vault on on-prem/non-Azure k8s clusters. In this blog post, I will show the steps I followed to demonstrate the process of mounting Azure Key Vault secrets inside an on-prem Kubernetes cluster.</p><ul><li><a class=link href=https://learn.microsoft.com/en-us/azure/key-vault/general/overview target=_blank rel=noopener><strong>Azure Key Vault</strong></a> is one of several key management solutions in Azure, and can be used to Securely store and tightly control access to tokens, passwords, <a class=link href=https://learn.microsoft.com/en-us/azure/key-vault/certificates/ target=_blank rel=noopener>certificates</a>, <a class=link href=https://learn.microsoft.com/en-us/azure/key-vault/keys/ target=_blank rel=noopener>API keys</a>, and other <a class=link href=https://learn.microsoft.com/en-us/azure/key-vault/secrets/ target=_blank rel=noopener>secrets</a>. Centralizing storage of application secrets in Azure Key Vault allows you to control their distribution. Key Vault greatly reduces the chances that secrets may be accidentally leaked. When using Key Vault, application developers no longer need to store security information in their application. Not having to store security information in applications eliminates the need to make this information part of the code.</li><li><a class=link href=https://kubernetes.io/docs/concepts/overview/ target=_blank rel=noopener><strong>Kubernetes</strong></a> is a portable, extensible, open source platform for managing containerized workloads and services, that facilitates both declarative configuration and automation. It has a large, rapidly growing ecosystem and focuses on the application workloads, not the underlying infrastructure components.</li><li><a class=link href=https://secrets-store-csi-driver.sigs.k8s.io/ target=_blank rel=noopener><strong>Kubernetes Secrets Store CSI Driver</strong></a> integrates secrets stores with Kubernetes via a <a class=link href=https://kubernetes-csi.github.io/docs/ target=_blank rel=noopener>Container Storage Interface (CSI)</a> volume. It allows Kubernetes to mount multiple secrets, keys, and certificates stored in enterprise-grade external secrets stores, such as Azure Key Vault, into pods as a volume. Once the Volume is attached, the data in it is mounted into the containerâ€™s file system.</li></ul><p>The Secrets Store CSI Driver on Azure Kubernetes Service (AKS) provides the following methods of identity-based access to your Azure key vault.</p><ul><li>An <a class=link href=https://learn.microsoft.com/en-us/azure/aks/use-azure-ad-pod-identity target=_blank rel=noopener>Azure Active Directory pod identity</a> (preview)</li><li>An <a class=link href=https://learn.microsoft.com/en-us/azure/aks/workload-identity-overview target=_blank rel=noopener>Azure Active Directory workload identity</a> (preview)</li><li>A <a class=link href=https://learn.microsoft.com/en-us/azure/active-directory/managed-identities-azure-resources/overview target=_blank rel=noopener>user-assigned or system-assigned managed identity</a></li><li>An <a class=link href=https://learn.microsoft.com/en-us/azure/active-directory/develop/app-objects-and-service-principals target=_blank rel=noopener>Azure Active Directory (AD) service principal</a></li></ul><blockquote><p><strong>NOTE:</strong> Service principals eventually expire and must be renewed to keep the cluster working. In addition, managing service principals adds complexity, thus it&rsquo;s recommended to use managed identities when working with Azure resources. Managed identities are the default authentication method for an AKS cluster.</p></blockquote><p>Given that the use-case in question is not AKS and the cluster is not hosted in Azure, we are left with no other option but to use service principals to <a class=link href=https://learn.microsoft.com/en-us/azure/key-vault/general/security-features#key-vault-authentication-options target=_blank rel=noopener>access Azure Key Vault</a>.</p><h2 id=create-a-new-kubernetes-cluster>Create a new Kubernetes Cluster</h2><p>If you do not have an on-prem Kubernetes cluster, you can follow instructions at <a class=link href=https://www.linuxtechi.com/install-kubernetes-cluster-on-debian/ target=_blank rel=noopener>How to Install Kubernetes Cluster on Debian 11 with Kubeadm</a> to create a cluster on Hyper-V.</p><h2 id=create-a-new-azure-key-vault>Create a new Azure key vault</h2><p>In addition to a Kubernetes cluster, you&rsquo;ll need an Azure key vault resource that stores the secret content in the cloud.</p><h3 id=create-a-new-resource-group>Create a new Resource Group</h3><p>To create a new resource group, execute the following command:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>$GROUP_NAME</span><span class=o>=</span>secret-store-example
</span></span><span class=line><span class=cl><span class=nv>$LOCATION</span><span class=o>=</span>canadacentral
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>az group create -n <span class=nv>$GROUP_NAME</span> -l <span class=nv>$LOCATION</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=create-a-new-azure-key-vault-resource>Create a new Azure Key Vault resource</h3><p>Execute the following command to create a new Azure Key vault resource:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>KEYVAULT_NAME</span><span class=o>=</span>secret-store-6d9e5b0a
</span></span><span class=line><span class=cl>az keyvault create -n <span class=nv>$KEYVAULT_NAME</span> -g <span class=nv>$GROUP_NAME</span> -l <span class=nv>$LOCATION</span>
</span></span></code></pre></td></tr></table></div></div><blockquote><p><strong>NOTE:</strong> The key vault&rsquo;s name must be globally unique.</p></blockquote><h3 id=create-key-vault-secrets>Create Key Vault secrets</h3><p>In this example, you&rsquo;ll create two plain-text secrets in our Key vault as follows:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>az keyvault secret <span class=nb>set</span> --vault-name <span class=nv>$KEYVAULT_NAME</span> -n Username --value atomic_fifth
</span></span><span class=line><span class=cl>az keyvault secret <span class=nb>set</span> --vault-name <span class=nv>$KEYVAULT_NAME</span> -n Password --value Forty7<span class=p>&amp;</span>Scale
</span></span></code></pre></td></tr></table></div></div><h2 id=create-a-service-principal>Create a Service Principal</h2><p>Next, create a service principal with the following commands:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ <span class=nv>SP_NAME</span><span class=o>=</span>secret-store-service-principal
</span></span><span class=line><span class=cl>$ az ad sp create-for-rbac --skip-assignment --name <span class=nv>$SP_NAME</span>
</span></span></code></pre></td></tr></table></div></div><p>The command should output a JSON object similar to this::</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;appId&#34;</span><span class=p>:</span> <span class=s2>&#34;&lt;GUID&gt;&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;displayName&#34;</span><span class=p>:</span> <span class=s2>&#34;secret-store-service-principal&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;password&#34;</span><span class=p>:</span> <span class=s2>&#34;&lt;STRING&gt;&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;tenant&#34;</span><span class=p>:</span> <span class=s2>&#34;&lt;GUID&gt;&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>You will need all four values in later steps, so it&rsquo;s important to note them down at this point.</p><h2 id=assign-permissions-to-key-vault>Assign Permissions to Key vault</h2><p>Access to a key vault is controlled through two interfaces: the management plane and the data plane. The management plane is where you manage Key Vault itself. Operations in this plane include creating and deleting key vaults, retrieving Key Vault properties, and updating access policies. The data plane is where you work with the data stored in a key vault. You can add, delete, and modify keys, secrets, and certificates. To grant our service principal permissions to read keys, secrets, and certificates, we execute the following commands:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># Set environment variables</span>
</span></span><span class=line><span class=cl><span class=nv>CLIENT_ID</span><span class=o>=</span>&lt;appId from previous step&gt;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>az keyvault set-policy -n <span class=nv>$KEYVAULT_NAME</span> --key-permissions get --spn <span class=nv>$CLIENT_ID</span>
</span></span><span class=line><span class=cl>az keyvault set-policy -n <span class=nv>$KEYVAULT_NAME</span> --secret-permissions get --spn <span class=nv>$CLIENT_ID</span>
</span></span><span class=line><span class=cl>az keyvault set-policy -n <span class=nv>$KEYVAULT_NAME</span> --certificate-permissions get --spn <span class=nv>$CLIENT_ID</span>
</span></span></code></pre></td></tr></table></div></div><p>The rest of this process is completed in our on-prem Kubernetes cluster.</p><h2 id=install-the-secrets-store-csi-driver>Install the Secrets Store CSI Driver</h2><p>To install the <a class=link href=https://github.com/kubernetes-sigs/secrets-store-csi-driver target=_blank rel=noopener>Secrets Store CSI Driver</a> on a fresh Kubernetes installation, execute the following script:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>BASE_URL</span><span class=o>=</span>https://raw.githubusercontent.com/kubernetes-sigs/secrets-store-csi-driver/main/deploy
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>kubectl apply -f <span class=nv>$BASE_URL</span>/rbac-secretproviderclass.yaml
</span></span><span class=line><span class=cl>kubectl apply -f <span class=nv>$BASE_URL</span>/csidriver.yaml
</span></span><span class=line><span class=cl>kubectl apply -f <span class=nv>$BASE_URL</span>/secrets-store.csi.x-k8s.io_secretproviderclasses.yaml
</span></span><span class=line><span class=cl>kubectl apply -f <span class=nv>$BASE_URL</span>/secrets-store.csi.x-k8s.io_secretproviderclasspodstatuses.yaml
</span></span><span class=line><span class=cl>kubectl apply -f <span class=nv>$BASE_URL</span>/secrets-store-csi-driver.yaml
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># If using the driver to sync secrets-store content as Kubernetes Secrets, deploy the additional RBAC permissions</span>
</span></span><span class=line><span class=cl><span class=c1># required to enable this feature</span>
</span></span><span class=line><span class=cl>kubectl apply -f <span class=nv>$BASE_URL</span>/rbac-secretprovidersyncing.yaml
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># If using the secret rotation feature, deploy the additional RBAC permissions</span>
</span></span><span class=line><span class=cl><span class=c1># required to enable this feature</span>
</span></span><span class=line><span class=cl>kubectl apply -f <span class=nv>$BASE_URL</span>/rbac-secretproviderrotation.yaml
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># If using the CSI Driver token requests feature (https://kubernetes-csi.github.io/docs/token-requests.html) to use</span>
</span></span><span class=line><span class=cl><span class=c1># pod/workload identity to request a token and use with providers</span>
</span></span><span class=line><span class=cl>kubectl apply -f <span class=nv>$BASE_URL</span>/rbac-secretprovidertokenrequest.yaml
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># [OPTIONAL] To deploy driver on windows nodes</span>
</span></span><span class=line><span class=cl>kubectl apply -f <span class=nv>$BASE_URL</span>/secrets-store-csi-driver-windows.yaml
</span></span></code></pre></td></tr></table></div></div><p>This will produce the following output:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>serviceaccount/secrets-store-csi-driver created
</span></span><span class=line><span class=cl>clusterrole.rbac.authorization.k8s.io/secretproviderclasses-role created
</span></span><span class=line><span class=cl>clusterrolebinding.rbac.authorization.k8s.io/secretproviderclasses-rolebinding created
</span></span><span class=line><span class=cl>csidriver.storage.k8s.io/secrets-store.csi.k8s.io created
</span></span><span class=line><span class=cl>customresourcedefinition.apiextensions.k8s.io/secretproviderclasses.secrets-store.csi.x-k8s.io created
</span></span><span class=line><span class=cl>customresourcedefinition.apiextensions.k8s.io/secretproviderclasspodstatuses.secrets-store.csi.x-k8s.io created
</span></span><span class=line><span class=cl>daemonset.apps/csi-secrets-store created
</span></span><span class=line><span class=cl>clusterrole.rbac.authorization.k8s.io/secretprovidersyncing-role created
</span></span><span class=line><span class=cl>clusterrolebinding.rbac.authorization.k8s.io/secretprovidersyncing-rolebinding created
</span></span><span class=line><span class=cl>clusterrole.rbac.authorization.k8s.io/secretproviderrotation-role created
</span></span><span class=line><span class=cl>clusterrolebinding.rbac.authorization.k8s.io/secretproviderrotation-rolebinding created
</span></span><span class=line><span class=cl>clusterrole.rbac.authorization.k8s.io/secretprovidertokenrequest-role created
</span></span><span class=line><span class=cl>clusterrolebinding.rbac.authorization.k8s.io/secretprovidertokenrequest-rolebinding created
</span></span><span class=line><span class=cl>daemonset.apps/csi-secrets-store-windows created
</span></span></code></pre></td></tr></table></div></div><h2 id=install-the-azure-key-vault-provider-for-secrets-store-csi-driver>Install the Azure Key Vault Provider for Secrets Store CSI Driver</h2><p><a class=link href=https://github.com/Azure/secrets-store-csi-driver-provider-azure target=_blank rel=noopener>Azure Key Vault provider for Secrets Store CSI Driver</a> allows you to get secret contents stored in an Azure Key Vault instance and use the Secrets Store CSI driver interface to mount them into Kubernetes pods. To install the Azure Key Vault provider for Secrets Store CSI Driver, execute the following command on the cluster:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl apply -f https://raw.githubusercontent.com/Azure/secrets-store-csi-driver-provider-azure/master/deployment/provider-azure-installer.yaml
</span></span></code></pre></td></tr></table></div></div><p>This will produce output as follows:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>serviceaccount/csi-secrets-store-provider-azure created
</span></span><span class=line><span class=cl>daemonset.apps/csi-secrets-store-provider-azure created
</span></span></code></pre></td></tr></table></div></div><h2 id=create-service-principal-kubernetes-secret>Create Service Principal Kubernetes Secret</h2><p>In order for your on-prem Kubernetes cluster to connect to Azure Key Vault, you will need to create <a class=link href=https://kubernetes.io/docs/concepts/configuration/secret/ target=_blank rel=noopener>Kubernetes secrets</a> accessible to the Secret Store CSI Driver. To create the secrets, execute the following commands against the cluster:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>$SECRET_NAME</span><span class=o>=</span>secrets-store-creds
</span></span><span class=line><span class=cl><span class=c1># $CLIENT_ID is the App ID of your service principal</span>
</span></span><span class=line><span class=cl><span class=c1># $CLIENT_SECRET is the Password of your service principal</span>
</span></span><span class=line><span class=cl>kubectl create secret generic <span class=nv>$SECRET_NAME</span> --from-literal <span class=nv>clientid</span><span class=o>=</span><span class=nv>$CLIENT_ID</span> --from-literal <span class=nv>clientsecret</span><span class=o>=</span><span class=nv>$CLIENT_SECRET</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Label the secret</span>
</span></span><span class=line><span class=cl><span class=c1># Refer to https://secrets-store-csi-driver.sigs.k8s.io/load-tests.html for more details on why this is necessary in future releases.</span>
</span></span><span class=line><span class=cl>kubectl label secret <span class=nv>$SECRET_NAME</span> secrets-store.csi.k8s.io/used<span class=o>=</span><span class=nb>true</span>
</span></span></code></pre></td></tr></table></div></div><blockquote><p><strong>NOTE:</strong><br>Kubernetes Secrets are, by default, stored unencrypted in the API server&rsquo;s underlying data store (etcd). Anyone with API access can retrieve or modify a Secret, and so can anyone with access to etcd. Additionally, anyone who is authorized to create a Pod in a namespace can use that access to read any Secret in that namespace; this includes indirect access such as the ability to create a Deployment.</p><p>In order to restrict access to Kubernetes secrets, consider enabling or configuring <a class=link href=https://kubernetes.io/docs/reference/access-authn-authz/authorization/ target=_blank rel=noopener>RBAC rules</a> with least-privilege access to Secrets.</p><p>See <a class=link href=https://kubernetes.io/docs/concepts/configuration/secret/#information-security-for-secrets target=_blank rel=noopener>Information security for Secrets</a> for more details.</p></blockquote><h2 id=deploy-the-secret-provider-class>Deploy the Secret Provider Class</h2><p>Create a YAML file:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>nano secret-provider-class.yaml
</span></span></code></pre></td></tr></table></div></div><p>Paste the following contents and save the file:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>secrets-store.csi.x-k8s.io/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>SecretProviderClass</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>azure-keyvault                               </span><span class=w> </span><span class=c># The Name of the Secret Provider Class</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>provider</span><span class=p>:</span><span class=w> </span><span class=l>azure</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>parameters</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>usePodIdentity</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;false&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>useVMManagedIdentity</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;false&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>userAssignedIdentityID</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>keyvaultName</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;secret-store-6d9e5b0a&#34;</span><span class=w>             </span><span class=c># The name of the Key Vault we created in earlier steps</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>tenantId</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;&lt;GUID&gt;&#34;</span><span class=w>                                </span><span class=c># The tenant Id returned from the `az ad sp create-for-rbac` command</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>objects</span><span class=p>:</span><span class=w>  </span><span class=p>|</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>      array:
</span></span></span><span class=line><span class=cl><span class=sd>        - |
</span></span></span><span class=line><span class=cl><span class=sd>          objectName: Username                        # The Key Vault secret we created in previous step
</span></span></span><span class=line><span class=cl><span class=sd>          objectType: secret
</span></span></span><span class=line><span class=cl><span class=sd>          objectVersion: &#34;&#34;
</span></span></span><span class=line><span class=cl><span class=sd>        - |
</span></span></span><span class=line><span class=cl><span class=sd>          objectName: Password                        # The Key Vault secret we created in previous step
</span></span></span><span class=line><span class=cl><span class=sd>          objectType: secret
</span></span></span><span class=line><span class=cl><span class=sd>          objectVersion: &#34;&#34;</span><span class=w>      
</span></span></span></code></pre></td></tr></table></div></div><p>Deploy the Secret Provider Class:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl apply -f secret-provider-class.yaml
</span></span></code></pre></td></tr></table></div></div><h2 id=create-a-pod-to-consume-azure-key-vault-secrets>Create a Pod to consume Azure Key Vault Secrets</h2><p>Create a YAML file:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>nano busybox-secrets-store-inline.yaml
</span></span></code></pre></td></tr></table></div></div><p>Paste the following contents and save the file:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>busybox-secrets-store-inline</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>busybox</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>k8s.gcr.io/e2e-test-images/busybox:1.29</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>command</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s2>&#34;/bin/sleep&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s2>&#34;10000&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>volumeMounts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>secrets-store-inline</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;/mnt/secrets-store&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>readOnly</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>secrets-store-inline</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>csi</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>driver</span><span class=p>:</span><span class=w> </span><span class=l>secrets-store.csi.k8s.io</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>readOnly</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>volumeAttributes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>secretProviderClass</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;azure-keyvault&#34;</span><span class=w>     </span><span class=c># The Name of the Secret Provider Class created in previous step</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>nodePublishSecretRef</span><span class=p>:</span><span class=w>                       </span><span class=c># Only required when using service principal mode</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>secrets-store-creds                </span><span class=w> </span><span class=c># The name of the Kubernetes secret created in previous step.</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>Deploy the pod:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl apply -f busybox-secrets-store-inline.yaml
</span></span></code></pre></td></tr></table></div></div><p>The command should produce the following output:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>pod/busybox-secrets-store-inline created
</span></span></code></pre></td></tr></table></div></div><h2 id=verify-azure-key-vault-secrets-in-container>Verify Azure Key Vault Secrets in container</h2><p>To verify that your secrets are accessible inside our container, you execute the following commands:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ kubectl <span class=nb>exec</span> busybox-secrets-store-inline -- ls /mnt/secrets-store
</span></span><span class=line><span class=cl>Username
</span></span><span class=line><span class=cl>Password
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>$ kubectl <span class=nb>exec</span> busybox-secrets-store-inline -- cat /mnt/secrets-store/Username
</span></span><span class=line><span class=cl>atomic_fifth
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>$ kubectl <span class=nb>exec</span> busybox-secrets-store-inline -- cat /mnt/secrets-store/Username
</span></span><span class=line><span class=cl>Forty7<span class=p>&amp;</span>Scale
</span></span></code></pre></td></tr></table></div></div><blockquote><p><strong>Important:</strong><br>You can reduce the exposure of your vaults by specifying which IP addresses have access to them. The <a class=link href=https://learn.microsoft.com/en-us/azure/key-vault/general/overview-vnet-service-endpoints target=_blank rel=noopener>Virtual network service endpoints for Azure Key Vault</a> allow you to restrict access to a list of IPv4 (internet protocol version 4) address ranges. Any user connecting to your key vault from outside those sources is denied access.</p><p>For more information, see <a class=link href=https://learn.microsoft.com/en-us/azure/key-vault/general/network-security target=_blank rel=noopener>Configure Azure Key Vault firewalls and virtual networks</a></p></blockquote><p>And there you have it! We managed to retrieve Azure Key Vault secrets from an on-prem Kubernetes cluster using a Service Principal. Hope the proves valuable to you, dear reader.</p><p>Credits:<br>Thanks to my colleagues <a class=link href=https://mvp.microsoft.com/en-us/PublicProfile/5002189 target=_blank rel=noopener>Ravi Yadav</a> and <a class=link href=https://hammadaslam.com/ target=_blank rel=noopener>Hammad Aslam</a> for the important pointers.</p><p>References:<br><a class=link href=https://www.j3ns.de/d365-business-central/use-azure-keyvaults-in-bc-onprem/ target=_blank rel=noopener>Use Azure KeyVaults in BC OnPrem</a><br><a class=link href=https://azure.github.io/secrets-store-csi-driver-provider-azure/docs/configurations/identity-access-modes/service-principal-mode/ target=_blank rel=noopener>Service Principal | Azure Key Vault Provider for Secrets Store CSI Driver</a><br><a class=link href=https://learn.microsoft.com/en-us/azure/aks/csi-secrets-store-driver target=_blank rel=noopener>Use the Azure Key Vault Provider for Secrets Store CSI Driver in an AKS cluster</a><br><a class=link href=https://github.com/kubernetes-sigs/secrets-store-csi-driver/ target=_blank rel=noopener>Kubernetes Secrets Store CSI Driver</a><br><a class=link href=https://secrets-store-csi-driver.sigs.k8s.io/getting-started/installation.html target=_blank rel=noopener>Installation - Secrets Store CSI Driver</a><br><a class=link href=https://azure.github.io/secrets-store-csi-driver-provider-azure/docs/getting-started/installation/ target=_blank rel=noopener>Installation | Azure Key Vault Provider for Secrets Store CSI Driver</a><br><a class=link href=https://learn.microsoft.com/en-us/azure/aks/csi-secrets-store-driver target=_blank rel=noopener>Use the Azure Key Vault Provider for Secrets Store CSI Driver in an AKS cluster</a><br><a class=link href=https://github.com/Azure/secrets-store-csi-driver-provider-azure/tree/master/examples/service-principal target=_blank rel=noopener>Service Principal Examples for Azure Key Vault Provider for Secrets Store CSI Driver</a><br><a class=link href=https://learn.microsoft.com/en-us/azure/key-vault/general/security-features target=_blank rel=noopener>Azure Key Vault security</a></p></section><footer class=article-footer><section class=article-tags><a href=/tags/kubernetes/>kubernetes</a>
<a href=/tags/azure/>azure</a>
<a href=/tags/keyvault/>keyvault</a>
<a href=/tags/secrets/>secrets</a></section><section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg><span>Licensed under CC BY-NC-SA 4.0</span></section><section class=article-lastmod><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg><span>Last updated on Nov 08, 2022 17:28 EST</span></section></footer></article><aside class=related-contents--wrapper><h2 class=section-title>Related contents</h2><div class=related-contents><div class="flex article-list--tile"><article class=has-image><a href=/blog/2022/05/06/integrate-nextjs-azure-cognitive-search/><div class=article-image><img src=/blog/2022/05/06/integrate-nextjs-azure-cognitive-search/cover.7e10197e305aadfade03b07d95edc074_hu0f9a87807e30aad5738be2ac078bda8f_9027_250x150_fill_box_smart1_3.png width=250 height=150 loading=lazy alt="Featured image of post HOW TO: Integrate Next.js with Azure Cognitive Search" data-key=integrate-nextjs-azure-cognitive-search data-hash="md5-fhAZfjBarfreA7B9le3AdA=="></div><div class=article-details><h2 class=article-title>HOW TO: Integrate Next.js with Azure Cognitive Search</h2></div></a></article><article class=has-image><a href=/blog/2021/08/30/build-sign-ios-application-using-azure-devops/><div class=article-image><img src=/blog/2021/08/30/build-sign-ios-application-using-azure-devops/cover.a649878786b9222ce8d7ef33d0c0b5f9_hu1baf13393af83955e60d8ead591edd95_56695_250x150_fill_box_smart1_3.png width=250 height=150 loading=lazy alt="Featured image of post How to Build and Sign iOs Application Using Azure DevOps" data-key=build-sign-ios-application-using-azure-devops data-hash="md5-pkmHh4a5Iizo1+8z0MC1+Q=="></div><div class=article-details><h2 class=article-title>How to Build and Sign iOs Application Using Azure DevOps</h2></div></a></article><article class=has-image><a href=/blog/2021/04/21/restore-database-on-container-start-up/><div class=article-image><img src=/blog/2021/04/21/restore-database-on-container-start-up/cover.0d8af13e6f29965bc2ba2e172fd5521e_hua6d920ccffbe7712bb5e078193bdddf7_60920_250x150_fill_q75_box_smart1.jpg width=250 height=150 loading=lazy alt="Featured image of post Restore Database on Container Start Up" data-key=restore-database-on-container-start-up data-hash="md5-DYrxPm8pllvCui4XL9VSHg=="></div><div class=article-details><h2 class=article-title>Restore Database on Container Start Up</h2></div></a></article><article class=has-image><a href=/blog/2021/04/07/dockerizing-blazor-wasm-application/><div class=article-image><img src=/blog/2021/04/07/dockerizing-blazor-wasm-application/cover.a9c08f53aa62f9f51530980806a05209_hu54647e4733936e0a413cf65fbe4dc5e0_77413_250x150_fill_q75_box_smart1.jpg width=250 height=150 loading=lazy alt="Featured image of post Dockerizing Blazor Wasm Application" data-key=dockerizing-blazor-wasm-application data-hash="md5-qcCPU6pi+fUVMJgIBqBSCQ=="></div><div class=article-details><h2 class=article-title>Dockerizing Blazor Wasm Application</h2></div></a></article><article class=has-image><a href=/blog/2021/03/23/optimizing-dockerfile-startup-script-with-environment-variables/><div class=article-image><img src=/blog/2021/03/23/optimizing-dockerfile-startup-script-with-environment-variables/cover.30218be0d5339fa6b4a4b029c6839a85_hu79b5dba812486e751d6f5b1c2c232866_25286_250x150_fill_box_smart1_3.png width=250 height=150 loading=lazy alt="Featured image of post Optimizing Dockerfile Startup Script With Environment Variables" data-key=optimizing-dockerfile-startup-script-with-environment-variables data-hash="md5-MCGL4NUzn6a0pLApxoOahQ=="></div><div class=article-details><h2 class=article-title>Optimizing Dockerfile Startup Script With Environment Variables</h2></div></a></article></div></div></aside><script src=https://giscus.app/client.js data-repo=achingono/achingono.github.io data-repo-id="MDEwOlJlcG9zaXRvcnkxNjE3MTg1NzM=" data-category=general data-category-id=DIC_kwDOCaOhLc4COKuY data-mapping=title data-reactions-enabled=1 data-emit-metadata=0 data-theme=light data-lang=en crossorigin=anonymous async></script>
<script>function setGiscusTheme(e){let t=document.querySelector("iframe.giscus-frame");t&&t.contentWindow.postMessage({giscus:{setConfig:{theme:e}}},"https://giscus.app")}(function(){addEventListener("message",t=>{if(event.origin!=="https://giscus.app")return;e()}),window.addEventListener("onColorSchemeChange",e);function e(){setGiscusTheme(document.documentElement.dataset.scheme==="light"?"light":"dark_dimmed")}})()</script><footer class=site-footer><section class=copyright>&copy;
2020 -
2022 Alfero Chingono</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.10.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.css integrity="sha256-c0uckgykQ9v5k+IqViZOZKc47Jn7KQil4/MP3ySA3F8=" crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.css integrity="sha256-SBLU4vv6CA6lHsZ1XyTdhyjJxCjPif/TRkjnsyGAGnE=" crossorigin=anonymous></main><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">Table of contents</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#create-a-new-kubernetes-cluster>Create a new Kubernetes Cluster</a></li><li><a href=#create-a-new-azure-key-vault>Create a new Azure key vault</a><ol><li><a href=#create-a-new-resource-group>Create a new Resource Group</a></li><li><a href=#create-a-new-azure-key-vault-resource>Create a new Azure Key Vault resource</a></li><li><a href=#create-key-vault-secrets>Create Key Vault secrets</a></li></ol></li><li><a href=#create-a-service-principal>Create a Service Principal</a></li><li><a href=#assign-permissions-to-key-vault>Assign Permissions to Key vault</a></li><li><a href=#install-the-secrets-store-csi-driver>Install the Secrets Store CSI Driver</a></li><li><a href=#install-the-azure-key-vault-provider-for-secrets-store-csi-driver>Install the Azure Key Vault Provider for Secrets Store CSI Driver</a></li><li><a href=#create-service-principal-kubernetes-secret>Create Service Principal Kubernetes Secret</a></li><li><a href=#deploy-the-secret-provider-class>Deploy the Secret Provider Class</a></li><li><a href=#create-a-pod-to-consume-azure-key-vault-secrets>Create a Pod to consume Azure Key Vault Secrets</a></li><li><a href=#verify-azure-key-vault-secrets-in-container>Verify Azure Key Vault Secrets in container</a></li></ol></nav></div></section></aside></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.5/dist/vibrant.min.js integrity="sha256-5NovOZc4iwiAWTYIFiIM7DxKUXKWvpVEuMEPLzcm5/g=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script>
<script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>